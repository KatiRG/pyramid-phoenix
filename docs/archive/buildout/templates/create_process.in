#!${python}

import sys
import os
import shutil


if __name__ == '__main__':

    if len(sys.argv) > 1:
        proc_path = os.path.join('${pywps-conf:processes-path}', sys.argv[1] + '.py')
        conf_path = os.path.realpath(os.path.join('${pywps-conf:processes-path}', '../process_configs', sys.argv[1] + '.conf'))

        if os.path.isfile(proc_path) or os.path.isfile(conf_path):
            print 'A process with this name already exists.'
        else:
            shutil.copyfile('${buildout:directory}/buildout_templates/proc.in', proc_path)
            shutil.copyfile('${buildout:directory}/buildout_templates/proc_conf.in', conf_path)

            f = open(conf_path, 'r')
            conf = f.read().format(identifier=sys.argv[1])
            f.close()

            f = open(conf_path, 'w')
            f.write(conf)
            f.close()

            init_path = os.path.join('${pywps-conf:processes-path}', '__init__.py')

            f = open(init_path, 'r')
            all = eval(f.read().strip().split('=')[1])
            all.append(sys.argv[1])
            all = list(set(all))
            f.close()

            f = open(init_path, 'w')
            f.write('__all__ = ' + str(all))
            f.close()

            print 'Process created'
            print '---------------'
            print 'CFG: ' + conf_path
            print 'SRC: ' + proc_path
    else:
        print 'USAGE: ' + sys.argv[0] + ' <PROCESS NAME>'
