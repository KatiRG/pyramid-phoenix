# Phoenix: a pyramid web frontend for WPS 
upstream phoenix {
    server unix://${socket} fail_timeout=0;
}

# caching
# http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=phoenix:20m inactive=7d max_size=4g;

server 
{
    listen ${ports:http};
    server_name _;

    root /usr/share/nginx/www;      
    index index.php index.html index.htm;

    # Phoenix ...
    # -----------

    location / 
    {
        # checks for static file, if not found proxy to app
        try_files $uri @proxy_to_phoenix;
    }

    # Local Docs ...
    location /docs
    {
        alias                   ${buildout:directory}/docs/html;
    }

    # esg search proxy at /esg-search/
    # http://stackoverflow.com/questions/7957998/nginx-caching-ajax
    location /esg-search 
    {
        proxy_pass              ${esgf:esg_search};
        proxy_cache             phoenix;
        proxy_cache_valid any   7d;       
        proxy_cache_use_stale   error timeout invalid_header updating http_500 http_502 http_503 http_504;
    }

    # phoenix pyramid app
    location @proxy_to_phoenix 
    {
        proxy_pass              http://phoenix;
    }

    # pywps avail at /wps
    location /wps {
        proxy_pass              ${malleefowl:wps};
    }

    # thredds avail at /thredds
    location /thredds {
        proxy_pass              ${malleefowl:thredds};
    }

    # ipython notebook avail at /ipython
    location /ipython {
        proxy_pass              http://localhost:${ports:ipython}/ipython;
    }

}
