# Phoenix: a pyramid web frontend for WPS 
upstream phoenix {
    server ${parts.phoenix.server} fail_timeout=0;
}

# caching
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=phoenix:20m inactive=7d max_size=4g;

server 
{
    listen ${parts.ports.http};
    server_name _;

    root /usr/share/nginx/www;      
    index index.php index.html index.htm;

    # Phoenix ...
    # -----------

    location / 
    {
        # checks for static file, if not found proxy to app
        try_files $$uri @proxy_to_phoenix;
    }

    # Local Docs ...
    location /docs
    {
        alias                   ${parts.buildout.directory}/docs/html;
    }

    # esg search proxy at /esg-search/
    # http://stackoverflow.com/questions/7957998/nginx-caching-ajax
    location /esg-search 
    {
        proxy_pass              http://136.172.30.96/esg-search/;
        proxy_cache             phoenix;
        proxy_cache_valid any   7d;       
        proxy_cache_use_stale   error timeout invalid_header updating http_500 http_502 http_503 http_504;
    }

    # phoenix pyramid app
    location @proxy_to_phoenix 
    {
        proxy_pass              http://phoenix;
    }

    # pywps avail at /wps
    location /wps 
    {
        proxy_pass              ${parts.malleefowl.wps};
    }

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    location ~ .php$ {
        fastcgi_pass 127.0.0.1:${parts.ports.php_fpm};
        fastcgi_index index.php;
        include fastcgi_params;
    }

}
