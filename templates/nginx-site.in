{% if parts.nginx_sites.phoenix == 'enabled' %}
# Phoenix: a pyramid web frontend for WPS 
upstream phoenix {
    server ${parts.phoenix.server} fail_timeout=0;
}
{% end %}

{% if parts.nginx_sites.pywps == 'enabled' %}
# pywps web processing service
upstream pywps_server {
    # socket connection
    server ${parts.pywps.server} fail_timeout=0;
}
{% end %}

# caching
proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=microcache:30m max_size=1000m;

server 
{
    listen ${parts.ports.http};
    server_name _;

    root /usr/share/nginx/www;      
    index index.php index.html index.htm;

    {% if parts.nginx_sites.phoenix == 'enabled' %}
    # Phoenix ...
    # -----------

    location / 
    {
        # checks for static file, if not found proxy to app
        try_files $$uri @proxy_to_phoenix;
    }

    # Local Docs ...
    location /docs
    {
        alias                   ${parts.buildout.directory}/docs/html;
    }

    # esg search proxy at /esg-search/
    # http://stackoverflow.com/questions/7957998/nginx-caching-ajax
    location /esg-search 
    {
        proxy_pass              http://136.172.30.96/esg-search/;
        proxy_cache             microcache;
        proxy_cache_valid       200 24h;
        proxy_cache_use_stale   updating;
        proxy_ignore_headers    Cache-Control Expires;
    }

    # phoenix pyramid app
    location @proxy_to_phoenix 
    {
        proxy_pass              http://phoenix;
    }
    {% end %}

    {% if parts.nginx_sites.pywps == 'enabled' %}
    # PyWPS ...
    # ---------

    # pywps avail at /wps
    location /wps 
    {
        proxy_pass              http://pywps_server;
    }

    # WPS Outputs
    location /wpsoutputs
    {
        alias ${parts.pywps_config.output_path};
    }

    # published data
    location /files
    {
        alias ${parts.pywps_config.files_path};
        autoindex on;
    }
    {% end %}

    {% if parts.nginx_sites.php_fpm == 'enabled' %}
    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    location ~ .php$ {
        fastcgi_pass 127.0.0.1:${parts.ports.php_fpm};
        fastcgi_index index.php;
        include fastcgi_params;
    }
    {% end %}

}
