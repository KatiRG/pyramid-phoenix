[phoenix_build]

parts =
    phoenix
    phoenix_python
    phoenix_config
    phoenix_logrotate
    phoenix_gunicorn
    phoenix_script
    phoenix_supervisor
    phoenix_deploy
    phoenix_nose   

[phoenix]
recipe = z3c.recipe.scripts
eggs = 
    Phoenix
    OWSLib
    authomatic
    Sphinx
    sphinx_bootstrap_theme

home = ${install:prefix}/var/lib/phoenix
cfg = ${install:prefix}/etc/phoenix.ini
server = unix:${install:prefix}/var/run/phoenix.socket
log_file = ${install:prefix}/var/log/phoenix.log

[phoenix_python]
recipe = z3c.recipe.scripts
eggs =
    ${phoenix:eggs} 
interpreter = python_phoenix

[phoenix_config]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/phoenix.ini.in
output = ${buildout:parts-directory}/phoenix/phoenix.ini

[phoenix_logrotate]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/logrotate.in
output = ${buildout:parts-directory}/phoenix/logrotate

log_file = ${phoenix:log_file}

[phoenix_gunicorn]
recipe = zc.recipe.egg
eggs =
    gunicorn
    Paste
    PasteDeploy
    ${phoenix:eggs}
scripts =
    gunicorn_paster=gunicorn_phoenix

[phoenix_script]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/phoenix.sh.in
output = ${buildout:bin-directory}/phoenix.sh
mode = 755

[phoenix_supervisor]
recipe = collective.recipe.template
input = ${buildout:directory}/templates/supervisor.conf.in
output = ${buildout:parts-directory}/phoenix/supervisor.conf

program = phoenix
command = ${buildout:bin-directory}/phoenix.sh
directory =  ${buildout:bin-directory}
priority = 90
environment =

[phoenix_deploy]
recipe = collective.recipe.cmd
on_install = true
on_update = true
cmds =
    sudo cp ${buildout:parts-directory}/phoenix/phoenix.ini ${phoenix:cfg}
    sudo cp ${buildout:parts-directory}/phoenix/logrotate /etc/logrotate.d/phoenix
    sudo cp ${buildout:parts-directory}/phoenix/supervisor.conf /etc/supervisor/conf.d/phoenix.conf

[phoenix_nose]
recipe = z3c.recipe.scripts
eggs =
    nose
    ${phoenix:eggs}
entry-points =
    nosetests=nose:run_exit
scripts =
    nosetests=nosetests
