<metal:block use-macro="main_template">
  <span  metal:fill-slot="content">
  <div id="content"></div>
<noscript>
<tal:form replace="structure noscriptform">The noscript form will render here</tal:form>
</noscript>
<div id="scriptOnly" style="display: none;">
Refresh period:
<input id="reloadTime" type="range" min="1" max="50" value="5" step="1" onchange="showValue()"/>
<span id="range">5</span>
</div>

<script type="text/javascript">
  $(function(){
    $('body').popover({
      selector: '[data-toggle="popover"]'});
    $('body').tooltip({
      selector: 'a[rel="tooltip"], [data-toggle="tooltip"]'});
  }); 
  var orderBy = "starttime";
  var orderType = "inverted";
  var request = new XMLHttpRequest();
  var timer = null;
  function sort(value){
      if(orderBy==value){
          if(orderType=="normal"){
              orderType="inverted";}
          else{
              orderType="normal";}}
      orderBy = value;

      //reuse the code to clear timer and reload
      showValue()
      };

  function reload(){
     request.open('post','jobsupdate/'+orderBy+'/'+orderType,true);
     request.send(null);
     request.onreadystatechange = update};

    function update(){
        switch (request.readyState){
            case 4:
                if (request.status == 200) {
                    var content = request.responseText;
                    // den Inhalt des Requests in das <div> schreiben
                    var selected = document.getElementsByName("selected");
                    var selectedValues = new Array();
                    j=0;
                    for(i=0; i < selected.length;i++){
                        if(selected[i].checked){
                        selectedValues[j] = selected[i].value;
                        j++;}}
                    $("*").tooltip('hide')
                    $("*").popover('hide')
                    document.getElementById('content').innerHTML = content;
                    selected = document.getElementsByName("selected");
                    for(j=0; j < selectedValues.length;j++){
                        for(i=0; i < selected.length;i++){
                            if(selected[i].value==selectedValues[j]){
                                selected[i].checked = true;
                                break;}}}
                    var reloadTime =  document.getElementById("reloadTime").value;
                    timer = setTimeout("reload()",reloadTime*1000);
                    //Add an arrow for the sort direction
                    text = document.getElementById(orderBy);
                    if(orderType=="normal"){
                        text.innerHTML+="&#x25B2;";}
                    else{
                        text.innerHTML+="&#x25BC;";}
                    }
                break;
            default:
                break;}};
  
  function showValue(){
      document.getElementById("range").innerHTML=document.getElementById("reloadTime").value;
      clearTimeout(timer);
      reload();}
  function pageLoaded(){    
      var hiddendiv = document.getElementById('scriptOnly')
      hiddendiv.style.display="";
      reload();}
  document.addEventListener("DOMContentLoaded", pageLoaded, false);
</script>

</span>
</metal:block>
